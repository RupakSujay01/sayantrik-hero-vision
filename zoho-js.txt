//$Id$
/*Powered by Zoho Recruit*/
/**
 * Version 1.1
 */
window.rec_embed_js =  window.rec_embed_js ||
	{
	rec_ajax : function(properties, callback){
		"use strict";//NO I18N

		let job_http_request = new XMLHttpRequest();
		job_http_request.rec_job_properties = properties;
		job_http_request.rec_success_callback= callback;
		job_http_request.onreadystatechange = function(data){
			if (this.readyState === 4) {
				let response = JSON.parse(this.response);
				let properties = this.rec_job_properties;
				let listingDiv = document.querySelector("#"+this.rec_job_properties.widget_id);//NO I18N
				if(this.status === 200){
					if(response && response.code ==="success" && response.data && response.data.length ===0){
						listingDiv.textContent = properties.empty_job_msg;
						return;
					}else{
						this.rec_success_callback(response, properties);
					}
				}else if(response && response.message){
					listingDiv.textContent = response.message;
					return;
				}
			}
		}
		job_http_request.open("GET", properties.site+"/recruit/v2/public/Job_Openings?pagename="+encodeURIComponent(properties.page_name)+ (properties.source ? "&source="+encodeURIComponent(properties.source) : "")+(properties.extra_fields ? "&extra_fields="+encodeURIComponent(JSON.stringify(properties.extra_fields)): ""), true);
		job_http_request.withCredentials = false;
		job_http_request.send();
	},
	
	show_hide_rec_loading : function(listingDiv, properties, isHide){
		"use strict";//NO I18N
		if(isHide){
			let loadingTag = listingDiv.querySelector(".cw-easyapply-loading");//NO I18N
			if(loadingTag){
				loadingTag.parentElement.removeChild(loadingTag);
			}
		}else{
			properties.brand_color = properties.brand_color || "#338cf0";//NO I18N
			listingDiv.appendChild(rec_embed_js.create_element({name:"div",attrs:{"class":"cw-easyapply-loading"}, "child":[//NO I18N
				{name:"div",attrs:{"style":"background-color:"+properties.brand_color}},//NO I18N
				{name:"div",attrs:{"style":"background-color:"+properties.brand_color}},//NO I18N
				{name:"div",attrs:{"style":"background-color:"+properties.brand_color}}//NO I18N
				] }));
		}
	},
	
	"print_facets": function(widget_id, data, facets){//NO I18N
		let facetObj = {}, facetSysRefArr = [];
		facets.forEach(function(eachF){
			facetObj[eachF.api_name] = {};
		});

		facetSysRefArr = Object.keys(facetObj);

		data.forEach(function(each_data){
			facetSysRefArr.forEach(function(api_name){
				let facetObjValues = facetObj[api_name];
				let content = each_data[api_name], contentArr;
				if(Array.isArray(content) && content && content.length >0){
					contentArr = content;
				}
				content = content && typeof content === "object" ? content.name : content;//NO I18N
				if(content && content !== null && content !== undefined && content !== "null"){
					contentArr= [content];
				}
				if(contentArr && contentArr.length >0){
					contentArr.forEach(function(each_content){
						facetObjValues[each_content] = facetObjValues[each_content] !== undefined ? facetObjValues[each_content] +1 : 1;
					});
				}
			});
		});
		let widget_elem = document.getElementById(widget_id);
		let widget_facet_elem = rec_embed_js.create_element({name:"div",//NO I18N
			attrs:{"class":"rec_facet_group","data-widgetid":widget_id}//NO I18N
		});
		widget_facet_elem.addEventListener("click", function(event){//NO I18N
			let target = event.target;
			if(target.nodeName === "INPUT" && target.type === "checkbox"){
				let closest_ul = rec_embed_js.find_closest(target, undefined, "rec_facet_group");//NO I18N
				
				let filterValues = {};
				Array.prototype.slice.call(closest_ul.querySelectorAll(".rec_ul_filter")).forEach(function(eachFilterUl){//NO I18N
					let selectedValues = [];
					Array.prototype.slice.call(eachFilterUl.querySelectorAll("input:checked")).forEach(function(eachInput){//NO I18N
						selectedValues.push(rec_embed_js.find_closest( eachInput, "li").dataset.value);
					});
					if(selectedValues.length){
				    	filterValues[eachFilterUl.dataset.sysrefname] = selectedValues;
					}
				});
				let widget_data = window[closest_ul.dataset.widgetid+"_data"], properties = window[closest_ul.dataset.widgetid+"_properties"];
				rec_embed_js.print_jobs(widget_data.data, widget_data.info, filterValues, properties);
			}
		});

		facets.forEach(function(eachFacet){
			let facetValuesObj = facetObj[eachFacet.api_name];
			if(facetValuesObj && Object.keys(facetValuesObj).length > 0){
				let ulElement = rec_embed_js.create_element({name:"ul", attrs:{"class":"rec_ul_filter","data-sysrefname":eachFacet.api_name}});//NO I18N
				
				Object.keys(facetValuesObj).sort().forEach(function(eachFacetValue){
					let li = rec_embed_js.create_element({name:"li",attrs:{"data-value":eachFacetValue}, "child":[//NO I18N
							{name:"label", attrs: {"class":"cw-facet-checkbox-label"}, "child":[//NO I18N
								{name:"input",attrs:{"type":"checkbox","class":"cw-facet-checkbox"}},//NO I18N
								{name:"span","text":(eachFacet.api_name === 'Remote_Job' ? eachFacet.field_label : eachFacetValue )+" ("+facetValuesObj[eachFacetValue]+")"}//NO I18N
								]
							}
						]});

					ulElement.appendChild(li);
				});
				let mainDiv;
				if(eachFacet.api_name === 'Remote_Job'){
					mainDiv = rec_embed_js.create_element({name:"div", "child":[//NO I18N
						{name:"div", attrs:{"class":"cw-rec-filter"}, childNode: ulElement}//NO I18N
					]});
				}else{
					mainDiv = rec_embed_js.create_element({name:"div",attrs:{"class":"job-type-div"}, "child":[//NO I18N
						{name:"span",attrs:{"class":"job-type"},"text":eachFacet.field_label},//NO I18N
						{name:"div", attrs:{"class":"cw-rec-filter"}, childNode: ulElement}//NO I18N
					]});
				}
				widget_facet_elem.appendChild(mainDiv);
			}
		});
		widget_elem.querySelector(".rec_filter_cls").appendChild(widget_facet_elem);//NO I18N
	},
	"find_closest": function(element, nodeName, class_name){//NO I18N
		let parent = element.parentNode;
		if(parent !== null && (nodeName !== undefined && parent.nodeName.toLowerCase() === nodeName || class_name !== undefined && parent.classList.contains(class_name))){
			return parent;
		}
		return rec_embed_js.find_closest(parent, nodeName, class_name);
	},
	"load":function(properties){//NO I18N
		"use strict";//NO I18N
	
		let listingDiv = document.querySelector("#"+properties.widget_id);//NO I18N
		rec_embed_js.show_hide_rec_loading(listingDiv, properties, false);
	
		let successCallback = function(response, properties) {
			window[properties.widget_id+"_data"]=response;
			window[properties.widget_id+"_properties"] = properties;
			let data = response.data, facets= response.info && response.info.facets;
			
			document.getElementById(properties.widget_id).append(rec_embed_js.create_element({name:"div",attrs:{"class":"rec_filter_cls"}}));//NO I18N
			
			if(facets && facets.length){
				rec_embed_js.print_facets(properties.widget_id, data, facets);
			}
			
			rec_embed_js.print_jobs(data, response.info, {}, properties);
			
			if(response.info && response.info.layout === 3){
				let _search_elm = rec_embed_js.create_element({name:"div", attrs:{"class":"rec-what-where"}, child:[//NO I18N
					{name:"input",attrs:{"class":"rec-job-info searchWhat",placeholder:response.info.keys._search1}},//NO I18N
					{name:"input",attrs:{"class":"rec-job-info searchWhere",placeholder:response.info.keys._search2}},//NO I18N
					{name:"input",attrs:{"class":"rec-job-info searchButton",type:"button",value:response.info.keys._search3, "data-nojob":response.info.keys._no_result, style:"color:#fff;background-color:"+response.info.brand_color,onclick:"rec_embed_js.rec_search(event.target)"}}//NO I18N
				]});
				document.querySelector(".embed_jobs_head3").prepend(_search_elm);//NO I18N
			}
			
		};
	
		rec_embed_js.rec_ajax(properties, successCallback);
	},
	
	"print_jobs": function(jobs, resp_info, opted_filter, properties){//NO I18N
		let empty_grouping_value =[], job_groups ={}, filterKeys = opted_filter && Object.keys(opted_filter), 
		//groupingFldName = resp_info.facets ? "" : resp_info && resp_info.groups && resp_info.groups[0].api_name;
		groupingFldName = resp_info && resp_info.groups && resp_info.groups[0].api_name, widget_id = properties.widget_id;
		for(let eachInd=0; eachInd < jobs.length; eachInd++){
			let eachJob = jobs[eachInd];
			
			/*apply filter starts*/
			if(filterKeys && filterKeys.length){
				let displayJob = true;
				for(let filterIndex = 0; filterIndex < filterKeys.length;  filterIndex++){
					let eachFilter = filterKeys[filterIndex], jobVal = eachJob[eachFilter];
					jobVal = jobVal && typeof jobVal === "object" ? jobVal.name : jobVal;//NO I18N
					displayJob = displayJob && jobVal && jobVal !== null && opted_filter[eachFilter].indexOf(jobVal) >= 0;
					if(Array.isArray(eachJob[eachFilter]) && eachJob[eachFilter] && eachJob[eachFilter].length > 0){
						for(let eachFilterVal = 0; eachFilterVal < opted_filter[eachFilter].length ; eachFilterVal++){
							displayJob = displayJob || eachJob[eachFilter].indexOf(opted_filter[eachFilter][eachFilterVal]) >=0 ;
						}
					}
				}
				if(!displayJob){
					continue;
				}
			}
			/*apply filter ends*/
			
			let groupingValue = eachJob[groupingFldName];
			groupingValue = groupingValue !== null && groupingValue !== undefined && typeof groupingValue === "object" ? groupingValue.name : groupingValue;//NO I18N
			if(groupingValue === undefined || groupingValue === null || groupingValue.trim().length ===0){
				empty_grouping_value.push(eachJob);
			}else{
				if(!job_groups[groupingValue]){
					job_groups[groupingValue]= [];
				}
				job_groups[groupingValue].push(eachJob);
			}
		}
		let listingDiv = document.getElementById(widget_id);
		let job_listing_elem = listingDiv.querySelector("."+widget_id+"_jobs") ? listingDiv.querySelector("."+widget_id+"_jobs") :  rec_embed_js.create_element({name:"div",attrs:{"class":widget_id+"_jobs"}});//NO I18N
		job_listing_elem.innerHTML = "";
		rec_embed_js.show_hide_rec_loading(listingDiv, properties, true);
		
		if(Object.keys(job_groups).length ===0 && empty_grouping_value.length === 0){
			job_listing_elem.textContent = properties.empty_job_msg;
		}else{
			let groupElem = rec_embed_js.get_group_jobs(job_groups, resp_info, undefined, properties), otherElem =rec_embed_js.get_group_jobs({"Others":empty_grouping_value}, resp_info, true, properties);//NO I18N
			let _group_options_arr = [{name: "option", attrs:{"value":"0"}, "text":resp_info.keys._all}];//NO I18N
			if(groupElem !== ""){
				job_listing_elem.appendChild(groupElem);
				
				Object.keys(job_groups).sort().forEach(function(_each_val){
					_group_options_arr.push({name: "option", attrs:{"value":_each_val}, "text":_each_val});//NO I18N
				});
			}
			if(empty_grouping_value.length){
				job_listing_elem.appendChild(otherElem);
				
				_group_options_arr.push({name: "option", attrs:{"value":"Others"}, "text":"Others"});//NO I18N
			}
			/**
			 * Filter element 
			 */
			if(_group_options_arr.length >1 && !document.querySelector(".rec-grp-drop") && resp_info.layout !== 3){
				let _job_group_filter=document.createDocumentFragment();
				_job_group_filter.append(rec_embed_js.create_element({name:"div", attrs:{"class":"rec-job-filter"}, child:[{name: "select", attrs:{"class":"rec-grp-drop"},"child":_group_options_arr}]}));//NO I18N

				document.querySelector("#"+properties.widget_id+" .rec_filter_cls").prepend(_job_group_filter);//NO I18N
				
				document.querySelector(".embed_jobs_head").querySelector(".rec-grp-drop").addEventListener("change", function(event){//NO I18N
					let target = event.target;
					_all_groups=document.querySelectorAll(".rec-grp-heading, .rec-group");//NO I18N
					_all_groups.forEach(function(_each_group){
						if(target.value !== "0" && _each_group.getAttribute("data-finder") !== target.value){
							_each_group.classList.add("rec-dis-none");//NO I18N
						}else{
							_each_group.classList.remove("rec-dis-none");//NO I18N
						}
					});

				});
			}
		}
		listingDiv.appendChild(job_listing_elem);
	},
	
	get_group_jobs: function(job_groups, resp_info, no_grouping, properties){
		if(job_groups && Object.keys(job_groups).length ===0){
			return "";
		}
		let _extra_field_info={};
		if(properties.extra_fields && properties.extra_fields.length){
			resp_info.fields.forEach(function(_each_field){
				if(properties.extra_fields.includes(_each_field.api_name)){
					_extra_field_info[_each_field.api_name]=_each_field;
				}
			});
		}
		
		let jobListingFrg = document.createDocumentFragment(), grouping_values = Object.keys(job_groups).sort();
		for(let eachGroupIndex =0; eachGroupIndex < grouping_values.length; eachGroupIndex ++){
			let groupName = grouping_values[eachGroupIndex], groupValues = job_groups[groupName], groupUl = rec_embed_js.create_element({name:"ul", attrs:{"class":"rec-group","data-finder":groupName}});//NO I18N

			if(!no_grouping){
				jobListingFrg.appendChild(rec_embed_js.create_element({name: "h2", attrs:{"class":"rec-grp-heading","data-finder":groupName}, "child": [//NO I18N
					{name:"span",attrs:{"class":"rec-grp-name"},"text":groupName},//NO I18N
					{name:"span",attrs:{"class":"rec-grp-cnt"},"text": (groupValues.length == 1 ? resp_info.keys._job : resp_info.keys._jobs).replace("{0}", groupValues.length)}//NO I18N
					] }) );
			}
			
			for(let eachJobIndex = 0; eachJobIndex < groupValues.length; eachJobIndex++){
				let eachJob = groupValues[eachJobIndex]; 
				let _template_childs=[], _title_elem;
				let job_title = [{name:"a",attrs:{href:eachJob.$url,target:"_blank",rel:"noopener noreferrer","style":"color:"+(properties.brand_color || resp_info.brand_color)},"text":eachJob.Job_Opening_Name ? eachJob.Job_Opening_Name : eachJob.Posting_Title }]//NO I18N

				if(!eachJob.Publish){
					job_title.push({name:"span",attrs:{"style":"padding: 3px 10px; font-size: 15px; color: #ed524a; border-radius: 10px; background: #feeceb;margin-left: 10px;white-space:nowrap;"}, "text": resp_info.keys._closed_jobs});
				}
				_title_elem = {name:"li",attrs:{"class":"rec-job-title"},"child":job_title}; //NO I18N
				
				switch(resp_info.layout){
				case 1:
					rec_embed_js._layout1(eachJob, resp_info, _template_childs, _title_elem, properties);
					rec_embed_js._extra_fields_data(properties, eachJob, _extra_field_info, _template_childs);
					break;
				case 2:
					rec_embed_js._layout2(eachJob, resp_info, _template_childs, _title_elem, properties);
					rec_embed_js._extra_fields_data(properties, eachJob, _extra_field_info, _template_childs);
					break;
				case 3:
					rec_embed_js._layout3(eachJob, resp_info, _template_childs, _title_elem, properties, _extra_field_info);
				}
				
				
				
				groupUl.appendChild(rec_embed_js.create_element( {name:"ul", attrs:{"class":"rec-job-info"},"child":_template_childs}));//NO I18N
			}
			jobListingFrg.appendChild(groupUl);
		}
		return jobListingFrg;
	},
	
	_extra_fields_data:function(properties, eachJob, _extra_field_info, _template_childs){
		/**
		 * Extra fields information
		 */
		if(properties.extra_fields && properties.extra_fields.length){
			properties.extra_fields.forEach(function(api_name){
				if(eachJob[api_name]){
					_template_childs.push({name:"li",attrs:{"class":"zrsite_"+api_name},"child":[//NO I18N
						{name:"span", "text":_extra_field_info[api_name].field_label},//NO I18N
						{name:"span", "text":eachJob[api_name]}//NO I18N
					]});
				}
			});
		}
	},
	
	_layout1:function(eachJob, resp_info, _template_childs, _title_elem, properties){
		/**
		 * 1.Job Type 
		 */
		if(eachJob.Job_Type){
			_template_childs.push({name:"li",attrs:{"class":"zrsite_Job_Type"},text:eachJob.Job_Type});
		}
		/**
		 * 2. Title
		 */
		_template_childs.push(_title_elem);
		
		/**
		 * 3. Location 
		 */
		
		if(eachJob.Remote_Job){
			_template_childs.push({name:"li",attrs:{"class":"zrsite_Location"},text:resp_info.keys._remote_job_title});
		}else{
			_template_childs.push({name:"li",attrs:{"class":"zrsite_Location"},text: eachJob.City && eachJob.Country ? (eachJob.City +", "+ eachJob.Country) : eachJob.City || eachJob.Country || "" });
		}
	},
	_layout2:function(eachJob, resp_info, _template_childs, _title_elem, properties){
		_template_childs.push(_title_elem);

		/**
		 * 1. Location
		 * */
		if(eachJob.Remote_Job){
			_template_childs.push({name:"li",attrs:{"class":"zrsite_Location"},text:resp_info.keys._remote_job_title});
		}else{
			_template_childs.push({name:"li",attrs:{"class":"zrsite_Location"},text: eachJob.City && eachJob.Country ? (eachJob.City +", "+ eachJob.Country) : eachJob.City || eachJob.Country || "" });
		}
		/**
		 * 2.Experience 
		 */
		if(eachJob.Work_Experience){
			_template_childs.push({name:"li",attrs:{"class":"zrsite_Work_Experience"},text:eachJob.Work_Experience});
		}

		/**
		 * 3.Description 
		 */
		if(eachJob.Job_Description){
			_template_childs.push({name:"li",attrs:{"class":"zrsite_Job_Description"},text:eachJob.Job_Description});
		}
		/**
		 * 4. Date Opened 
		 */
		if(eachJob.Date_Opened || eachJob.Job_Type){
			let _date_opened_child=[];
			if(eachJob.Date_Opened){
				_date_opened_child.push({name:"span",attrs:{"class":"zrsite_Date_Opened"},text:eachJob.Date_Opened});
			}
			if(eachJob.Job_Type){
				_date_opened_child.push({name:"span",attrs:{"class":"zrsite_Job_Type"},text:eachJob.Job_Type});
			}
			_template_childs.push({name:"li",attrs:{"class":"zrsite_Date_Opened"},child:_date_opened_child});
		}
	},
	_layout3: function(eachJob, resp_info, _template_childs, _title_elem, properties, _extra_field_info){
		let _job_seg_1=[];
		_job_seg_1.push(_title_elem);
		/**
		 * 1. Location
		 * */
		if(eachJob.Remote_Job){
			_job_seg_1.push({name:"li",attrs:{"class":"zrsite_Location"},text:resp_info.keys._remote_job_title});
		}else{
			let _location = [];
			if(eachJob.City){
				_location.push(eachJob.City);
			}
			if(eachJob.State){
				_location.push(eachJob.State);
			}
			if(eachJob.Country){
				_location.push(eachJob.Country);
			}
			_job_seg_1.push({name:"li",attrs:{"class":"zrsite_Location"},text: _location.join(", ")});
		}
		
		/**
		 * 2.Description 
		 */
		if(eachJob.Job_Description){
			_job_seg_1.push({name:"li",attrs:{"class":"zrsite_Job_Description"},text:eachJob.Job_Description});
		}
		rec_embed_js._extra_fields_data(properties, eachJob, _extra_field_info, _job_seg_1);

		_template_childs.push({name:"li",attrs:{"class":"zr_fillayout_info"},child:[
			{name:"ul",child:_job_seg_1}//NO I18N
		]})
		
		/**
		 * 3. job type and  Date Opened 
		 */
		if(eachJob.Date_Opened || eachJob.Job_Type){
			let _date_opened_child=[];
			if(eachJob.Date_Opened){
				_date_opened_child.push({name:"span",attrs:{"class":"zrsite_Date_Opened"},text:eachJob.Date_Opened});
			}
			if(eachJob.Job_Type){
				_date_opened_child.push({name:"span",attrs:{"class":"zrsite_Job_Type"},text:eachJob.Job_Type});
			}
			_template_childs.push({name:"li",attrs:{"class":"zrsite_Date_Opened"},child:_date_opened_child});
		}
		
	},
	create_element: function(json){
		let rec_elem; 
		if(json.name){
			rec_elem = document.createElement(json.name);
		}
		if(json.text){
			rec_elem.textContent = json.text;
		}
		for(let key in json.attrs) {
			rec_elem.setAttribute(key, json.attrs[key]);
		}
		if(json.child){
			for(let childInd =0; childInd < json.child.length; childInd++){
				rec_elem.appendChild(rec_embed_js.create_element(json.child[childInd]));
			}
		}
		if(json.childNode){
			rec_elem.appendChild(json.childNode);
		}
		return rec_elem;
	},
	rec_search: function(_target){
		rec_embed_js.rec_job_search(_target, document.querySelector(".rec-job-info.searchWhat").value, document.querySelector(".rec-job-info.searchWhere").value);//NO I18N
	},
	rec_job_search: function(_target, _s_what, _s_where){
		_s_what = _s_what.trim().toLowerCase(), _s_where = _s_where.trim().toLowerCase();
		let _job_list = document.querySelectorAll(".rec_job_listing_div_jobs .rec-job-info"), _hidden_job_count=0;//NO I18N
		_job_list.forEach(function(_each_job){
        	let _what_search=false, _where_search=false;
        	
        	/**
        	 * What
        	 */
        	if(_s_what){
        		_each_job.querySelectorAll('.rec-job-title,.zrsite_Job_Description,.zrsite_Required_Skills').forEach(function(_each_elem){//NO I18N
        			_what_search = _what_search || _each_elem.textContent.toLowerCase().indexOf(_s_what)>=0;
        		});
        	}

        	/**
        	 * Where
        	 */
        	if(_s_where){
        		_each_job.querySelectorAll('.zrsite_Country,.zrsite_City,.zrsite_State,.zrsite_Location').forEach(function(_each_elem){//NO I18N
        			_where_search = _where_search || _each_elem.textContent.toLowerCase().indexOf(_s_where)>=0;
        		});
        	}
        	if(!_s_where && !_s_what){
        		_found_search =true;
        	}else if(_s_what && _s_where){
        		_found_search = _what_search && _where_search;
        	}else if(_s_what){
        		_found_search = _what_search;
        	}else{
        		_found_search = _where_search;
        	}
        	
            if(_found_search){
            	_each_job.style.display=""
            }else{
            	_hidden_job_count++;
            	_each_job.style.display="none";
            }
        });
		let _no_job_elem = document.querySelector(".rec_no_jobs");//NO I18N
		
		if(_job_list.length ===  _hidden_job_count){
			_no_job_elem || document.querySelector(".rec_job_listing_div_jobs").append(rec_embed_js.create_element({name:"div",attrs:{"class":"rec_no_jobs"},text :_target.getAttribute("data-nojob")}));//NO I18N
		}else if(_no_job_elem){
			_no_job_elem.parentNode.removeChild(_no_job_elem);
		}
	}
}